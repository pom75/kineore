<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>KinéCab - Site de rendez-vous en ligne pour les Kinésithérapeute</title>
    <link rel="stylesheet" href="js/jquery-ui.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="icon" type="image/png" href="img/ck.png"/>
    <link href="fullcalendar/daygrid/main.css" rel="stylesheet">
    <link href="fullcalendar/timegrid/main.css" rel="stylesheet">
    <link href="fullcalendar/list/main.css" rel="stylesheet">
    <link href="fullcalendar/core/main.css" rel="stylesheet">
    <script src="fullcalendar/core/main.js"></script>
    <script src="fullcalendar/interaction/main.js"></script>
    <script src="fullcalendar/daygrid/main.js"></script>
    <script src="fullcalendar/timegrid/main.js"></script>
    <script src="fullcalendar/list/main.js"></script>
    <script src="js/jquery-2.1.1.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/bootstrap-autocomplete.min.js"></script>
    <script src="js/moment.js"></script>
    <script>
        window.onload = redirect;

        function redirect() {
            if (readCookie('session') == '') {
                window.location.href = ("/index.html");
            }
            if (readCookie('admin') == '0') {
                window.location.href = ("/index.html");
            }
        }

        function $_GET(param) {
            var vars = {};
            window.location.href.replace(location.hash, '').replace(
                /[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
                function (m, key, value) { // callback
                    vars[key] = value !== undefined ? value : '';
                }
            );

            if (param) {
                return vars[param] ? vars[param] : null;
            }
            return vars;
        }


        function readCookie(name) {
            var i, c, ca, nameEQ = name + "=";
            ca = document.cookie.split(';');
            for (i = 0; i < ca.length; i++) {
                c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1, c.length);
                }
                if (c.indexOf(nameEQ) == 0) {
                    return c.substring(nameEQ.length, c.length);
                }
            }
            return '';
        }

        function delete_cookie(name) {
            document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
            window.location.href = ("/index.html");
        }

        var idMotifMapCab = {};
        var currentIdAdmin = readCookie('idAdmin');

        //Select Admin Calendar
        if ($_GET('id') != null) {
            currentIdAdmin = $_GET('id');
        }
        $.ajax({
            data: {token: readCookie('session')},
            type: 'POST',
            url: '/admin/getallcabadmins',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    $('#adminName').empty();
                    jsonData.admins.forEach(admin => {
                        if (admin.id == currentIdAdmin) {
                            $('#adminName').append("<option value=\"" + admin.id + "\" selected=\"selected\">" + admin.prenom + "</option>");
                        } else {
                            $('#adminName').append("<option value=\"" + admin.id + "\">" + admin.prenom + "</option>");
                        }
                    })
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });


        //This one for the news events
        function getMotifColab() {
            $.ajax({
                data: {tokenAdmin: readCookie('session'), idAdmin: currentIdAdmin},
                type: 'POST',
                url: '/rdv/getmotifcolabbyidadmin',
                success: function (data, textStatus, jqXHR) {
                    var jsonData = JSON.parse(data);
                    if (jsonData.status === "OK") {
                        for (var i = 0; i < jsonData.motif.length; i++) {
                            $('#selectListIdMotif').append('<input class="form-check-input" name="day" type="checkbox" value="' + jsonData.motif[i].id + '" id="' + jsonData.motif[i].id + '"> <label class="form-check-label" for="' + jsonData.motif[i].id + '">' + jsonData.motif[i].motif + ' </label><br>');
                            $('#selectListIdMotif2').append('<input class="form-check-input" name="month" type="checkbox" value="' + jsonData.motif[i].id + '" id="' + jsonData.motif[i].id + '"> <label class="form-check-label" for="' + jsonData.motif[i].id + '">' + jsonData.motif[i].motif + ' </label><br>');
                        }
                    } else {
                        $('#modaleMessageTitle').text("Une erreur est survenue");
                        $('#dialog_title_span').text(jsonData.message);
                        $('#modalMessage').modal('toggle');
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#modalMessage').modal('toggle');
                }
            });
        }

        //This one for existing events, we can't break existing if the user remove
        function getMotifCab() {
            $.ajax({
                async: false,
                data: {tokenAdmin: readCookie('session')},
                type: 'POST',
                url: '/rdv/getmotiftokenadmin',
                success: function (data, textStatus, jqXHR) {
                    var jsonData = JSON.parse(data);
                    if (jsonData.status === "OK") {
                        for (var i = 0; i < jsonData.motif.length; i++) {
                            idMotifMapCab[jsonData.motif[i].id] = jsonData.motif[i];
                        }
                    } else {
                        $('#modaleMessageTitle').text("Une erreur est survenue");
                        $('#dialog_title_span').text(jsonData.message);
                        $('#modalMessage').modal('toggle');
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#modalMessage').modal('toggle');
                }
            });
        }
    </script>
</head>
<body>

<!-- ====================================================
header section -->
<header style="padding-bottom: 70px;">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top navbar-custom">
        <img src="img/ck.png" width="30" height="30">
        <a class="navbar-brand" href="index.html">&nbspKinécab</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
                aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="nav navbar-nav ml-auto">
                <li class="nav-item navbar-right">
                    <a class="nav-link navbar-right active" href="#">Mon Calendrier</a>
                </li>
                <li class="nav-item navbar-right">
                    <a class="nav-link navbar-right" href="#">Gestion Du Calendrier</a>
                </li>
                <li class="nav-item navbar-right">
                    <a class="nav-link navbar-right" href="gestioncabinet.html">Gestion Du Cabinet</a>
                </li>
                <li class="nav-item navbar-right">
                    <a class="nav-link navbar-right" href="profiladmin.html">Mon Compte</a>
                </li>
                <li class="nav-item navbar-right">
                    <a class="nav-link navbar-right" onclick="delete_cookie('session');delete_cookie('admin')" href="#">Deconnexion</a>
                </li>
            </ul>
        </div>
    </nav>
</header> <!-- end of header area -->

<!-- Body Calendar -->

<section class="about text-center mb-5" id="calendare">
    <div class="container">
        <!-- Main Title -->
        <h2>Planning de : <select class="selectpicker" data-width="fit" id="adminName">
            <option value="default" selected></option>
            <option value="15"></option>
        </select>
        </h2>
        <div class="row">

            <div id='calendar'></div>
        </div>
    </div>
</section>

<!-- Popup Month Selection -->

<div class="modal fade" id="MonthSelectionModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div
                class="modal-content">
            <div class="modal-header">
                <h3 id="titreSemaine"></h3>
            </div>
            <div class="modal-body">
                <form class="form-signin" id="connexion" method="POST">

                    <select class="form-control" id="daySelection">
                        <option value="default" selected>Veuillez faire un choix</option>
                        <option value="createDay">Créér de nouveaux rendez-vous</option>
                        <option value="dayOff">Supprimer les rendez-vous</option>
                    </select>

                    <div id="dayOff" class="daySelectect" style="display:none">
                        <h4>Tous les rendez-vous prit seront annuler.</h4>
                        <h4>Les patients ne pourons pas prendre de nouveaux rendez-vous.</h4>
                        <br>
                        <button class="btn btn-lg btn-primary btn-block" type="submit" id="setDayOff">Supprimer</button>
                    </div>

                    <div id="createDay" class="daySelectect" style="display:none">
                        <h4>Duree d'un rendez-vous : </h4>
                        <select class="form-control" id="dureeSelection">
                            <option value="default" selected></option>
                            <option value="15">15 min</option>
                            <option value="20">20 min</option>
                            <option value="30">30 min</option>
                        </select>
                    </div>
                    <div id="debutDaySelectionDiv" class="daySelectect" style="display:none">
                        <h4>Heure du premier rendez-vous : </h4>
                        <select class="form-control" id="debutDaySelection">
                        </select>
                    </div>
                    <div id="finDaySelectionDiv" class="daySelectect" style="display:none">
                        <h4>Heure du dernier rendez-vous : </h4>
                        <select class="form-control" id="finDaySelection">
                        </select>
                        <br>
                        <div class="form-check" id="selectListIdMotif2">
                        </div>
                        <br>
                        <button id="createListRdvDay" class="btn btn-lg btn-primary btn-block" type="submit">Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Popup Day selection -->

<div class="modal fade" id="timeGrid" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="timeGridTitle"></h3>
            </div>
            <div class="modal-body">
                <form class="form-signin" id="connexion2" method="POST">
                    <select class="form-control" id="timeGridSelect">
                        <option value="default" selected>Veuillez faire un choix</option>
                        <option value="createListRDV">Créer des crénos libre</option>
                        <option value="createPostIt">Créer un post-it</option>
                        <option value="suppRDV">Supprimer les rendez-vous</option>
                    </select>

                    <div id="suppRDVDiv" class="daySelectect2" style="display:none">
                        <br>
                        <h4>Tous les rendez-vous prit seront annuler.</h4>
                        <h4>Les patients ne pourons pas prendre de nouveaux rendez-vous dans ce créno.</h4>
                        <br>
                        <button id="suppHour" class="btn btn-lg btn-primary btn-block" type="submit">Supprimer</button>
                    </div>

                    <div id="createDay2" class="daySelectect2" style="display:none">
                        <br>
                        <h4>Motif du rendez-vous : </h4>
                        <br>
                        <div class="form-check" id="selectListIdMotif">
                        </div>
                        <br>
                        <button id="createListRdvHour" class="btn btn-lg btn-primary btn-block" type="submit">
                            Enregistrer
                        </button>
                    </div>

                    <div id="post-it" class="daySelectect2" style="display:none">
                        <br>
                        <h4>Titre</h4>
                        <input id="titrePostIt" type="text" class="form-control" name="titre" placeholder="Titre"
                               oninput="setCustomValidity( this.validity.patternMismatch ? 'Le champ est vide' : '')"/>
                        <h4>Description</h4>
                        <textarea class="form-control input-lg" style="resize:none" placeholder="Description"
                                  rows="5"
                                  id="descriptionPostIt"> </textarea>
                        <br>
                        <button id="create_PostIt" class="btn btn-lg btn-primary btn-block" type="submit">
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Popup Event New FREE -->

<div class="modal fade" id="popupSingleEvent" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog event-popup mb-5" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="eventFreeTitle"></h3>
            </div>
            <div class="modal-body">
                <form class="form-signin" id="eventFreeForm" method="POST">
                    <div id="bookEvent" class="daySelectect">
                        <h4>Nom du patient</h4>
                        <input id="namePat" type="text" class="form-control" name="nom" placeholder="Nom"
                               oninput="setCustomValidity( this.validity.patternMismatch ? 'Le champ est vide' : '')"/>
                        <h4>Motif du rendez-vous</h4>
                        <select class="form-control" id="eventMotifSelection">
                            <option value="default" selected>Veuillez faire un choix</option>
                        </select>
                        <h4>Informations complémentaire</h4>
                        <textarea class="form-control input-lg" placeholder="Information client" rows="5"
                                  id="commentEvent"></textarea>
                        <br>
                        <div class="float-sm-right" id="modifBlock">
                            <button type="button" id="saveEvent" class="btn btn-secondary float-left">Sauvegarder
                            </button>
                        </div>
                        <div class="float-sm-left">
                            <button type="button" id="suppEvent" class="btn btn-danger float-right">Supprimer</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Popup Event New WAITING -->

<div class="modal fade" id="popupSingleEventWaiting" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog event-popup mb-5" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="eventWaitingTitle"></h3>
            </div>
            <div class="modal-body">
                <form class="form-signin" id="eventFreeFormWaiting" method="POST">
                    <div id="WaitingEvent" class="daySelectect">
                        <input id="namePatWaiting" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <input id="numWaiting" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <input id="motifWaiting" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <textarea class="form-control input-lg" placeholder="Information client" rows="5"
                                  id="commentEventWaiting" readonly> </textarea>
                        <br>
                        <div class="float-sm-right" id="modifBlockWaiting">
                            <button type="button" id="accepteEventWaiting" class="btn btn-secondary float-left">Accepter
                            </button>
                        </div>
                        <div class="float-sm-left">
                            <button type="button" id="refuseEventWaiting" class="btn btn-danger float-right">Refuser
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Popup Event New BOOKED -->
<div class="modal fade" id="popupSingleEventBooked" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog event-popup mb-5" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="eventBookedTitle"></h3>
            </div>
            <div class="modal-body">
                <form class="form-signin" id="eventFreeFormBooked" method="POST">
                    <div id="BookedEvent" class="daySelectect">
                        <input id="namePatBooked" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <input id="numBooked" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <select class="form-control" id="motifBooked">
                        </select>
                        <br/>
                        <textarea class="form-control input-lg" style="resize:none" placeholder="Information client"
                                  rows="5"
                                  id="commentEventBooked"> </textarea>
                        <br>

                        <div class="form-group form-check">
                            <input class="form-check-input" type="checkbox" value="" id="pointe">
                            <label class="form-check-label" for="pointe">
                                Pointé
                            </label>
                        </div>
                        <div class="form-group form-check">
                            <input class="form-check-input" type="checkbox" value="" id="paye">
                            <label class="form-check-label" for="paye">
                                Payé
                            </label>
                            <button type="button" id="saveEventBooked" class="btn btn-secondary float-right">
                                Enregistrer
                            </button>
                        </div>
                        <br>
                        <br>
                        <div class="float-sm-right" id="modifBlockBooked">
                            <button type="button" id="cancelEventBooked" class="btn btn-secondary float-left">Annuler
                            </button>
                        </div>
                        <div class="float-sm-left">
                            <button type="button" id="suppEventBooked" class="btn btn-danger float-right">Supprimer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Popup Event CANCELED EVENT -->

<div class="modal fade" id="popupSingleEventCanceled" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog event-popup mb-5" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="eventCanceledTitle"></h3>
            </div>
            <div class="modal-body">
                <form class="form-signin" id="eventFreeFormCanceled" method="POST">
                    <div id="CanceledEvent" class="daySelectect">
                        <input id="namePatCanceled" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <input id="numCanceled" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <input id="motifCanceled" type="text" class="form-control" name="nom" placeholder="Nom"
                               value="" readonly/>
                        <br/>
                        <textarea class="form-control input-lg" placeholder="Information client" rows="5"
                                  id="commentEventCanceled" readonly> </textarea>
                        <br>
                        <div class="col-sm">
                            <button type="button" id="suppEventCanceled" class="btn btn-danger float-sm-right">Supprimer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Popup Event CANCELED EVENT -->

<div class="modal fade" id="popupPostIt" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog event-popup mb-5" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="postItTitle"></h3>
            </div>
            <div class="modal-body">
                <form class="form-signin" id="eventpostItPost" method="POST">
                    <div id="PostItEvent" class="daySelectect">
                        <h4>Titre</h4>
                        <input id="titrePostItModal" type="text" class="form-control" name="nom" placeholder="Nom"
                               oninput="setCustomValidity( this.validity.patternMismatch ? 'Le champ est vide' : '')"/>
                        <h4>Description</h4>
                        <textarea class="form-control input-lg" placeholder="Information client" rows="5"
                                  id="commentPostIt"></textarea>
                        <br>
                        <div class="float-sm-right" id="modifPostIt">
                            <button type="button" id="savePostIt" class="btn btn-secondary float-left">Sauvegarder
                            </button>
                        </div>
                        <div class="float-sm-left">
                            <button type="button" id="suppPostIt" class="btn btn-danger float-right">Supprimer</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Modal -->
<div class="modal fade" id="modalMessage" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
     aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modaleMessageTitle"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <span id="dialog_title_span"></span>
            </div>
        </div>
    </div>
</div>


<!-- footer starts here -->
<nav class="navbar fixed-bottom navbar-light bg-light align-items-center justify-content-center">
    © 2020 Copyright
</nav>

<!-- script tags ========================================= -->
<script>

    var idPersonMap = {};

    function getPerson() {
        $.ajax({
            data: {tokenAdmin: readCookie('session')},
            type: 'POST',
            url: '/rdv/getpersonidadmin',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    var idName = [];
                    for (var i = 0; i < jsonData.people.length; i++) {
                        idPersonMap[jsonData.people[i].id] = jsonData.people[i];
                        var obj = {};
                        var value = "value";
                        var label = "label";
                        obj[value] = jsonData.people[i].id;
                        obj[label] = jsonData.people[i].nom + " " + jsonData.people[i].prenom;
                        idName.push(obj);

                    }
                    $('#namePat').autocomplete({
                        'source': idName, delay: 0,
                        select: function (event, ui) {
                            event.preventDefault();
                            $("#namePat").val(ui.item.label);
                            $("#namePat").attr('name', ui.item.value);
                        }
                    });
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
    }

    var startDay;
    var endDay;
    var durationRDV;
    var startDayList;
    var endDayList;
    var calendar;
    var currentEvent;
    var added = false; // avoid duplication
    getPerson();


    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid', 'timeGrid'],
            header: {
                left: 'prev,next today',
                right: 'dayGridMonth,timeGridWeek,timeGridDay',
                today: 'todaay',
                month: 'month',
                week: 'week',
                day: 'day',
            },
            longPressDelay: 700,
            fixedWeekCount: false,
            allDaySlot: false,
            slotEventOverlap: true,
            slotDuration: '00:30:00',
            minTime: "07:00:00",
            maxTime: "21:00:00",
            droppable: true,
            weekends: false,
            displayEventTime: false,
            nowIndicator: true,
            buttonText: {
                today: 'now',
                month: 'mois',
                week: 'semaine',
                day: 'jour',
            },
            contentHeight: "auto",
            height: "auto",
            weekNumbers: false,
            weekNumbersWithinDays: true,
            selectable: true,
            defaultView: 'timeGridWeek',
            navLinks: true, // can click day/week names to navigate views
            editable: true,
            displayEventEnd: true,
            columnHeaderFormat: {weekday: 'short', month: 'numeric', day: 'numeric', omitCommas: true},
            firstDay: 1,
            select: function (selectionInfo) {
                //If Month view
                if (selectionInfo.view.type == "dayGridMonth") {
                    startDay = moment(selectionInfo.startStr);
                    startDay.set({hour: 7, minute: 0})
                    endDay = moment(selectionInfo.endStr).subtract(1, "days");
                    endDay.set({hour: 21, minute: 0})
                    if (startDay.format("dddd D MMMM") == endDay.format("dddd D MMMM")) {
                        $('#titreSemaine').html(startDay.format("dddd D MMMM"));
                    } else {
                        $('#titreSemaine').html(startDay.format("dddd D MMMM") + " au " + endDay.format("dddd D MMMM"));
                    }
                    resetMonthPopup();
                } //Else Week or Day view
                else {
                    startDay = moment(selectionInfo.startStr);
                    endDay = moment(selectionInfo.endStr);
                    $('#timeGridTitle').html(startDay.format("dddd D MMMM") + "   " + startDay.format("HH:mm") + " à " + endDay.format("HH:mm"));
                    resetWeekDayPopup()
                }
            },
            eventClick: function (info) {
                currentEvent = info;
                var data = info.event.extendedProps.data;
                var status = data.status;
                if (status.toUpperCase().localeCompare("BOOKED") == 0) {
                    $('#eventBookedTitle').html(moment(info.event.start).format("dddd D MMMM") + "   " + moment(info.event.start).format("HH:mm") + " à " + moment(info.event.end).format("HH:mm"));
                    $('#namePatBooked').val(data.nomPatient);
                    if (idPersonMap[data.idPatient] != null) {
                        $('#numBooked').val(idPersonMap[data.idPatient].tel);
                    } else {
                        $('#numBooked').val("Compte supprimé");
                    }
                    var motifs = data.listIdMotif.split(',');
                    $('#motifBooked').empty();
                    motifs.forEach(motif => {
                        if (motif === data.idMotif) {
                            $('#motifBooked').append("<option value=\"" + motif + "\"selected>" + idMotifMapCab[motif].motif + "</option>");
                        } else {
                            $('#motifBooked').append("<option value=\"" + motif + "\">" + idMotifMapCab[motif].motif + "</option>");
                        }
                    });
                    $('#commentEventBooked').val(data.info);
                    $("#pointe").prop("checked", data.pointe);
                    $("#paye").prop("checked", data.paye);
                    $('#popupSingleEventBooked').modal('show');
                }
                if (status.toUpperCase().localeCompare("WAITING") == 0) {
                    $('#eventWaitingTitle').html(moment(info.event.start).format("dddd D MMMM") + "   " + moment(info.event.start).format("HH:mm") + " à " + moment(info.event.end).format("HH:mm"));
                    $('#namePatWaiting').val(data.nomPatient);
                    if (idPersonMap[data.idPatient] != null) {
                        $('#numWaiting').val(idPersonMap[data.idPatient].tel);
                    } else {
                        $('#numWaiting').val("Compte supprimé");
                    }
                    $('#motifWaiting').val(idMotifMapCab[data.idMotif].motif);
                    $('#commentEventWaiting').val(data.info);
                    $('#popupSingleEventWaiting').modal('show');
                }
                if (status.toUpperCase().localeCompare("POST_IT") == 0) {
                    $('#postItTitle').html(info.event.title);
                    $('#titrePostItModal').val(info.event.title);
                    $('#commentPostIt').val(data.info);
                    $('#popupPostIt').modal('show');
                }
                if (status.toUpperCase().localeCompare("CANCELED") == 0) {
                    $('#eventCanceledTitle').html(moment(info.event.start).format("dddd D MMMM") + "   " + moment(info.event.start).format("HH:mm") + " à " + moment(info.event.end).format("HH:mm"));
                    $('#namePatCanceled').val(data.nomPatient);
                    if (idPersonMap[data.idPatient] != null) {
                        $('#numCanceled').val(idPersonMap[data.idPatient].tel);
                    } else {
                        $('#numCanceled').val("Compte supprimé");
                    }
                    $('#motifCanceled').val(idMotifMapCab[data.idMotif].motif);
                    $('#commentEventCanceled').val(data.info);
                    $('#popupSingleEventCanceled').modal('show');
                }
                if (status.toUpperCase().localeCompare("FREE") == 0) {
                    $('#namePat').val("");
                    $('#namePat').attr("name", null);
                    $('#commentEvent').val("");
                    $("#eventMotifSelection").val("default").change();
                    var motifs = data.listIdMotif.split(',');
                    $('#eventMotifSelection').empty();
                    $('#eventMotifSelection').append('<option value="default" selected>Veuillez faire un choix</option>');
                    motifs.forEach(motif => {
                        $('#eventMotifSelection').append("<option value=\"" + motif + "\">" + idMotifMapCab[motif].motif + "</option>");
                    });
                    $('#eventFreeTitle').html(moment(info.event.start).format("dddd D MMMM") + "   " + moment(info.event.start).format("HH:mm") + " à " + moment(info.event.end).format("HH:mm"));
                    $('#popupSingleEvent').modal('show');
                }
            },
            selectAllow:
                function (selectInfo) {
                    if (moment(selectInfo.start).isSame(selectInfo.end, 'day')) {
                        return true;
                    } else {
                        return selectInfo.allDay;
                    }
                },
            views: {
                dayGridMonth: {
                    eventLimit: 6 // adjust to 6 only for timeGridWeek/timeGridDay
                }
            },
            events: function (info, successCallback, failureCallback) {
                if (added) {
                    added = false;
                    calendar.getEvents().forEach(function (event) {
                        event.remove();
                    })
                }
                var events = getEvents(moment(info.start).format("YYYY-MM-DD HH:mm:ss"), moment(info.end).format("YYYY-MM-DD HH:mm:ss"));
                successCallback(events);
            },
            eventDrop: function (info) {
                moveEvent([createJsonEvent(info.event)]);
                calendar.getEventById(info.event.id).remove();
            }
        });
        calendar.setOption('locale', 'fr');
        calendar.render();
    })
    ;

    function getEvents(start, end) {
        getMotifCab();
        getMotifColab();
        var listEvent = [];
        $.ajax({
            async: false,
            data: {start: start, end: end, tokenAdmin: readCookie('session'), idAdmin: currentIdAdmin},
            type: 'POST',
            url: '/rdv/getrdvbyidadmin',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    jsonData.rdvs.forEach(event => listEvent.push(createEventWithData(event)));
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
        return listEvent;
    }

    function createEventWithData(data) {
        startD = new Date(moment(data.start).format());
        endD = new Date(moment(data.end).format());


        //Default Free
        var title = "RDV Libre";
        var color = '#257e4a';
        if (data.status.toUpperCase().localeCompare("BOOKED") == 0) {
            data.idMotif
            title = data.nomPrenom;
            color = idMotifMapCab[data.idMotif].color;
        }
        if (data.status.toUpperCase().localeCompare("WAITING") == 0) {
            title = data.nomPrenom;
            color = '#b25f2a';
        }
        if (data.status.toUpperCase().localeCompare("CANCELED") == 0) {
            title = data.nomPrenom;
            color = '#b23421';
        }
        if (data.status.toUpperCase().localeCompare("POST_IT") == 0) {
            title = data.titrePostIt;
            color = '#FFF190';
        }
        return createNewEvent(data.id, title, moment(startD).format("YYYY-MM-DD HH:mm:ss"), moment(endD).format("YYYY-MM-DD HH:mm:ss"), color, data.status, data.idPatient, data.nomPrenom, data.idMotif, data.motif, data.duration, data.info, data.pointe, data.paye, data.listIdMotif, data.idAdmin);
    }


</script>
<script type="text/javascript">
    /* ------------------- Popup Month Selection ------------------- */

    var isChanged = false;
    //On select Menu
    $(function () {
        $('#daySelection').change(function () {
            $('.daySelectect').hide();
            if ($(this).val() == "createDay") {
                isChanged = true;
            } else {
                $("#dureeSelection").val("default").change();
            }
            $('#' + $(this).val()).show();
        });

    });

    //On select duree event
    $(function () {
        $('#dureeSelection').change(function () {
            if (isChanged) {
                durationRDV = $(this).val();
                $("#debutDaySelection").empty();
                var currentHours = moment(startDay);
                var endHours = moment(startDay);
                var hourTab = endDay.format("HH:mm").split(":");
                endHours = endHours.set({hour: hourTab[0], minute: hourTab[1]});
                $("#debutDaySelection").append("<option selected>  </option>");
                while (endHours.diff(currentHours) >= 0) {
                    $("#debutDaySelection").append("<option value='" + currentHours.format("HH:mm") + "'>" + currentHours.format("HH:mm") + "</option>");
                    currentHours.add(durationRDV, 'minutes');
                }
                $('#debutDaySelectionDiv').show();
                isChanged = false;
            }
        });

    });

    //On select start
    $(function () {
        $('#debutDaySelection').change(function () {
            $("#finDaySelection").empty();
            var hourTab = $(this).val().split(':');
            var currentHours = moment(startDay);
            currentHours.set({hour: hourTab[0], minute: hourTab[1]});
            startDayList = moment(currentHours);
            currentHours.add(durationRDV, 'minutes');
            var endHours = moment(startDay);
            hourTab = moment(endDay).format("HH:mm").split(":");
            endHours = endHours.set({hour: hourTab[0], minute: hourTab[1]});
            $("#finDaySelection").append("<option selected>  </option>");
            while (endHours.diff(currentHours) >= 0) {
                $("#finDaySelection").append("<option value='" + currentHours.format("HH:mm") + "'>" + currentHours.format("HH:mm") + "</option>");
                currentHours.add(durationRDV, 'minutes');
            }
            $('#finDaySelectionDiv').show();

        });

    });

    //On select end
    $(function () {
        $('#finDaySelection').change(function () {
            var hourTab = $(this).val().split(':');
            var currentHours = moment(endDay);
            currentHours.set({hour: hourTab[0], minute: hourTab[1]});
            endDayList = moment(currentHours);
        });

    });

    //On Save
    $("#createListRdvDay").click(function () {
        checked = $("input[name='month']:checked").length;
        if (!checked) {
            $('#dialog_title_span').html("Vous devez selectionner au moins 1 motif.");
            $('#modalMessage').modal('toggle');
            return false;
        }

        var listIdMotif = "";
        $.each($("input[name='month']:checked"), function () {
            listIdMotif += $(this).val();
            listIdMotif += ",";
        });
        listIdMotif = listIdMotif.substring(0, listIdMotif.length - 1); //remove coma

        $('#MonthSelectionModal').modal('hide');
        var currentDayStart = moment(startDayList);
        var currentDayStop = moment(startDayList);
        var hourTab = moment(endDayList).format("HH:mm").split(":");
        currentDayStop.set({hour: hourTab[0], minute: hourTab[1]});

        var currentWritter = moment(currentDayStart);

        var i = 0;
        var listEvent = [];
        while (endDayList.diff(currentWritter) >= 0) {
            var currentWritter = moment(currentDayStart);
            currentWritter.add(i, "days");
            var currentWritterStop = moment(currentDayStop);
            currentWritterStop.add(i, "days");
            while (currentWritterStop.diff(currentWritter) >= 0) {
                var integer = parseInt(durationRDV, 10);
                listEvent.push(createNewEvent(0, 'RDV Libre', currentWritter.format("YYYY-MM-DD HH:mm:ss"), currentWritter.add(durationRDV, 'minutes').format("YYYY-MM-DD HH:mm:ss"), '#257e4a', "free", "0", "", "", 0, integer, "", false, false, listIdMotif, readCookie('idAdmin')));
            }
            i++;
        }
        saveNewEvents(listEvent);
    });

    //Do nothing on submit
    $("#connexion").submit(function (e) {
        e.preventDefault();
    });

    //On remove events
    $("#setDayOff").click(function () {
        $('#MonthSelectionModal').modal('hide');
        removeEvent(startDay, endDay);
    });


    /* ------------------- Popup Day selection  ------------------- */

    // On menu selection
    $(function () {
        $('#timeGridSelect').change(function () {
            $('.daySelectect2').hide();
            if ($(this).val() == "suppRDV") {
                $('#suppRDVDiv').show();
            }
            if ($(this).val() == "createListRDV") {
                $('#createDay2').show();
            }
            if ($(this).val() == "createPostIt") {
                $("#titrePostIt").val('');
                $("#descriptionPostIt").val('');
                $('#post-it').show();
            }
        });

    });

    //On save post-it
    $("#create_PostIt").click(function () {
        $('#timeGrid').modal('hide');
        var duree = moment.duration(endDay.diff(startDay)).asMinutes();
        var titre = $("#titrePostIt").val();
        var description = $("#descriptionPostIt").val();
        var listEvent = [];
        listEvent.push(createNewEvent(0, titre, startDay.format("YYYY-MM-DD HH:mm:ss"), endDay.format("YYYY-MM-DD HH:mm:ss"), '#FFF190', "post_it", "0", "", "", 0, duree, description, false, false, "", readCookie('idAdmin')));
        saveNewEvents(listEvent);
    });

    //On save free event
    $("#createListRdvHour").click(function () {
        checked = $("input[name='day']:checked").length;
        if (!checked) {
            $('#dialog_title_span').html("Vous devez selectionner au moins 1 motif.");
            $('#modalMessage').modal('toggle');
            return false;
        }
        var listDuree = [];
        var listIdMotif = "";

        $.each($("input[name='day']:checked"), function () {
            listIdMotif += $(this).val();
            listIdMotif += ",";
            listDuree.push(idMotifMapCab[$(this).val()].duree);
        });

        listIdMotif = listIdMotif.substring(0, listIdMotif.length - 1); //remove last coma
        durationRDV = pgdcListe(listDuree);

        if (durationRDV === null) {
            $('#dialog_title_span').text("Erreur");
            $('#modaleMessageTitle').text("Les durées des motifs selectionné ne sont pas compatible. Veuillez selectionner d'autres motif ou changer les durées.");
            $('#modalMessage').modal('toggle');
            return;
        }

        $('#timeGrid').modal('hide');
        var currentWritter = moment(startDay);
        var listEvent = [];
        while (endDay.diff(currentWritter) > 0) {
            var integer = parseInt(durationRDV, 10);
            listEvent.push(createNewEvent(0, 'RDV Libre', currentWritter.format("YYYY-MM-DD HH:mm:ss"), currentWritter.add(durationRDV, 'minutes').format("YYYY-MM-DD HH:mm:ss"), '#257e4a', "free", "0", "", "", 0, integer, "", false, false, listIdMotif, readCookie('idAdmin')));
        }
        saveNewEvents(listEvent);
    });


    function changeStatusEvents(listEvent, status, idPatient) {
        $.ajax({
            data: {
                events: JSON.stringify(listEvent),
                tokenAdmin: readCookie('session'),
                status: status,
                idPat: idPatient
            },
            type: 'POST',
            url: '/rdv/changestatusevent',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    if (status.toUpperCase().localeCompare("REFUSE") == 0) {
                        // calendar.addEventSource(listEvent);
                        removeEvents(listEvent);
                        calendar.getEventById(currentEvent.event.id).remove();
                    }
                    added = true;
                    return true;
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                    calendar.refetchEvents();
                    return false;
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
                return false;
            }
        });
    }

    function changeStatusEventsAndCreateFree(listEvent, status, idPatient) {
        $.ajax({
            data: {
                events: JSON.stringify(listEvent),
                tokenAdmin: readCookie('session'),
                status: status,
                idPat: idPatient
            },
            type: 'POST',
            url: '/rdv/changestatusevent',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    var listDuree = [];
                    var tabMotif = currentEvent.event.extendedProps.data.listIdMotif.split(',');
                    tabMotif.forEach(id => {
                        listDuree.push(idMotifMapCab[id].duree);
                    });

                    durationRDV = pgdcListe(listDuree);

                    if (durationRDV === null) {
                        $('#dialog_title_span').text("Erreur");
                        $('#modaleMessageTitle').text("Les durées des motifs selectionné ne sont pas compatible. Veuillez selectionner d'autres motif ou changer les durées.");
                        $('#modalMessage').modal('toggle');
                        return;
                    }

                    var currentWritter = moment(currentEvent.event.start);
                    var listEvent = [];
                    while (moment(currentEvent.event.end).diff(currentWritter) > 0) {
                        var integer = parseInt(durationRDV, 10);
                        listEvent.push(createNewEvent(0, 'RDV Libre', currentWritter.format("YYYY-MM-DD HH:mm:ss"), currentWritter.add(durationRDV, 'minutes').format("YYYY-MM-DD HH:mm:ss"), '#257e4a', "free", "0", "", "", 0, integer, "", false, false, currentEvent.event.extendedProps.data.listIdMotif, readCookie('idAdmin')));
                    }
                    saveNewEvents(listEvent);
                    added = true;
                    calendar.getEventById(currentEvent.event.id).remove();
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                    calendar.refetchEvents();
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
    }

    function saveNewEvents(listEvent) {
        $.ajax({
            data: {events: JSON.stringify(listEvent), tokenAdmin: readCookie('session'), status: status},
            type: 'POST',
            url: '/rdv/addevent',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    jsonData.collect.sort((a, b) => a - b);
                    for (var i = 0; i < jsonData.collect.length; i++) {
                        listEvent[i].id = jsonData.collect[i];
                    }
                    calendar.addEventSource(listEvent);
                    added = true;
                    calendar.refetchEvents();
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
    }

    function safebookOneEvent(listEvent) {
        $.ajax({
            data: {events: JSON.stringify(listEvent), tokenAdmin: readCookie('session'), status: status},
            type: 'POST',
            url: '/rdv/safebookoneevent',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    calendar.addEventSource(listEvent);
                    added = true;
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                    calendar.refetchEvents();
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
    }

    function moveEvent(listEvent) {
        $.ajax({
            data: {events: JSON.stringify(listEvent), tokenAdmin: readCookie('session'), status: status},
            type: 'POST',
            url: '/rdv/moveevent',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    calendar.addEventSource(listEvent);
                    added = true;
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                    calendar.refetchEvents();
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
    }

    //On delete events
    $("#suppHour").click(function () {
        $('#timeGrid').modal('hide');
        removeEvent(startDay, endDay);
    });

    //DO nothing on submit
    $("#connexion2").submit(function (e) {
        e.preventDefault();
    });


    /* ------------------- Popup Event  ------------------- */
    //Save PostIt
    $("#savePostIt").click(function () {
        currentEvent.event.setProp("title", $('#titrePostItModal').val());
        currentEvent.event.extendedProps.data.info = $("#commentPostIt").val();
        $('#popupPostIt').modal('hide');
        savePostIt([createJsonEvent(currentEvent.event)]);
        calendar.getEventById(currentEvent.event.id).remove();
    });

    //Delete PostIt
    $("#suppPostIt").click(function () {
        $('#popupPostIt').modal('hide');
        calendar.getEventById(currentEvent.event.id).remove();
        removeEvents([createJsonEvent(currentEvent.event)]);
    });

    function savePostIt(listEvent) {
        $.ajax({
            data: {events: JSON.stringify(listEvent), tokenAdmin: readCookie('session'), status: status},
            type: 'POST',
            url: '/rdv/savepostit',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    calendar.addEventSource(listEvent);
                    added = true;
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                    calendar.refetchEvents();
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
    }


    //Save RDV
    $("#saveEvent").click(function () {
        var error = false;
        var errorText = "";
        var listToRemove = [];
        //TODO FUNCTION ERROR with return
        if ($('#namePat').val().length < 3) {
            errorText += "Nom du Patient inférieur à 3 caracteres. <br>";
            error = true;
        }
        if ($('#namePat').attr("name") == null) {
            errorText += "Nom du Patient inexistant, veuillez rajouter un nouveau patient. <br>";
            error = true;
        }
        if ($("#eventMotifSelection").val().toUpperCase().localeCompare("DEFAULT") == 0) {
            errorText += "Aucun Motif selectioné. <br>";
            error = true;
        }

        if (!error && currentEvent.event.extendedProps.data.duration != idMotifMapCab[$("#eventMotifSelection").val()].duree) {
            var duration = currentEvent.event.extendedProps.data.duration;
            var duree = idMotifMapCab[$("#eventMotifSelection").val()].duree;
            if (duration > duree) {
                errorText += "Impossible de choisir ce motif. <br>";
                error = true;
                return;
            }
            var events = calendar.getEvents().sort(function (a, b) {
                return a.start - b.start;
            });
            var quotient = Math.floor(duree / duration);
            var found = false;
            var currEvent = currentEvent.event;

            for (i = 0; i < events.length; i++) {
                if (currEvent.id === events[i].id) {
                    found = true;
                    continue;
                }
                if (found) {
                    if (moment(currEvent.start).isSame(moment(events[i].start))) {
                        continue;
                    }
                    if (moment(currEvent.end).isSame(moment(events[i].start))) {
                        var tabMotif = events[i].extendedProps.data.listIdMotif.split(',');
                        if (currEvent.extendedProps.data.duration === events[i].extendedProps.data.duration && events[i].extendedProps.data.status.toUpperCase().localeCompare("FREE") == 0 && tabMotif.includes($("#eventMotifSelection").val())) {
                            quotient--;
                            listToRemove.push(events[i]);
                            if (quotient <= 1) {
                                break;
                            } else {
                                currEvent = events[i];
                            }
                        }
                    } else {
                        break;
                    }
                }
                //motif est dans la liste des motif
                //liste chainé
            }
        }

        if (quotient > 1) {
            errorText += "Pas de assez de temps disponible pour ce motif, impossible de choisir ce motif. <br>";
            error = true;
        }

        if (error) {
            $('#dialog_title_span').html(errorText);
            $('#modalMessage').modal('toggle');
        } else {
            if (quotient === 1 && found) {
                currentEvent.event.setProp("durationEditable", true);
                currentEvent.event.setEnd(events[i].end);
                currentEvent.event.extendedProps.data.duration = duree;
                var jsonListToRemove = [];
                listToRemove.forEach(event => {
                    jsonListToRemove.push(createJsonEvent(event));
                    calendar.getEventById(event.id).remove();
                });
                removeEvents(jsonListToRemove);
            }
            $('#popupSingleEvent').modal('hide');
            setEventPropFreeToBooked(currentEvent.event);
            safebookOneEvent([createJsonEvent(currentEvent.event)]);
            calendar.getEventById(currentEvent.event.id).remove();
        }

    });

    function setEventPropFreeToBooked(event) {
        event.setProp("title", $('#namePat').val());
        event.setProp("color", idMotifMapCab[$("#eventMotifSelection").val()].color);
        event.extendedProps.data.status = "BOOKED";
        event.extendedProps.data.nomPatient = $('#namePat').val();
        event.extendedProps.data.idPatient = $('#namePat').attr("name");
        event.extendedProps.data.motif = $("#eventMotifSelection option:selected").text();
        event.extendedProps.data.idMotif = $("#eventMotifSelection").val();
        event.extendedProps.data.info = $("#commentEvent").val();
        event.extendedProps.title = $('#namePat').val();
        event.extendedProps.data.id = event.id;
    }

    // On delete event
    $("#suppEvent").click(function () {
        $('#popupSingleEvent').modal('hide');
        calendar.getEventById(currentEvent.event.id).remove();
        removeEvents([createJsonEvent(currentEvent.event)]);
    });

    //Do nothing on submit
    $("#eventFreeForm").submit(function (e) {
        e.preventDefault();
    });


    //Accepte RDV
    $("#accepteEventWaiting").click(function () {
        $('#popupSingleEventWaiting').modal('hide');
        currentEvent.event.setProp("color", idMotifMapCab[currentEvent.event.extendedProps.data.idMotif].color);
        currentEvent.event.extendedProps.data.status = "BOOKED";
        changeStatusEvents([createJsonEvent(currentEvent.event)], "ACCEPTE", currentEvent.event.extendedProps.data.idPatient);
        calendar.getEventById(currentEvent.event.id).remove();
    });

    //Refuse RDV
    $("#refuseEventWaiting").click(function () {
        $('#popupSingleEventWaiting').modal('hide');
        var tempIdPatient = currentEvent.event.extendedProps.data.idPatient;
        var listDuree = [];
        var tabMotif = currentEvent.event.extendedProps.data.listIdMotif.split(',');
        tabMotif.forEach(id => {
            listDuree.push(idMotifMapCab[id].duree);
        });

        durationRDV = pgdcListe(listDuree);

        if (durationRDV === null) {
            $('#dialog_title_span').text("Erreur");
            $('#modaleMessageTitle').text("Les durées des motifs selectionné ne sont pas compatible. Veuillez selectionner d'autres motif ou changer les durées.");
            $('#modalMessage').modal('toggle');
            return;
        }

        var currentWritter = moment(currentEvent.event.start);
        var listEvent = [];
        while (moment(currentEvent.event.end).diff(currentWritter) > 0) {
            var integer = parseInt(durationRDV, 10);
            listEvent.push(createNewEvent(0, 'RDV Libre', currentWritter.format("YYYY-MM-DD HH:mm:ss"), currentWritter.add(durationRDV, 'minutes').format("YYYY-MM-DD HH:mm:ss"), '#257e4a', "free", "0", "", "", 0, integer, "", false, false, currentEvent.event.extendedProps.data.listIdMotif, readCookie('idAdmin')));
        }
        currentEvent.event.setProp("color", '#257e4a');
        currentEvent.event.setProp("title", "RDV Libre");
        currentEvent.event.extendedProps.data.status = "FREE";
        currentEvent.event.extendedProps.data.idPatient = 0;
        currentEvent.event.extendedProps.data.idMotif = "";
        currentEvent.event.extendedProps.data.nomPatient = "";
        currentEvent.event.extendedProps.data.info = "";
        changeStatusEvents([createJsonEvent(currentEvent.event)], "REFUSE", tempIdPatient);
        saveNewEvents(listEvent);
    });

    //Do nothing on submit
    $("#eventFreeFormWaiting").submit(function (e) {
        e.preventDefault();
    });


    //Cancel Booked RDV
    $("#cancelEventBooked").click(function () {
        $('#popupSingleEventBooked').modal('hide');
        currentEvent.event.extendedProps.data.status = "CANCELED";
        currentEvent.event.setProp("color", '#b21809');
        changeStatusEventsAndCreateFree([createJsonEvent(currentEvent.event)], "CANCEL", currentEvent.event.extendedProps.data.idPatient);//cancel rdv
    });

    //Supp Booked RDV
    $("#suppEventBooked").click(function () {
        $('#popupSingleEventBooked').modal('hide');
        calendar.getEventById(currentEvent.event.id).remove();
        removeEvents([createJsonEvent(currentEvent.event)]);
    });

    //Save Booked RDV
    $("#saveEventBooked").click(function () {
        $('#popupSingleEventBooked').modal('hide');
        currentEvent.event.extendedProps.data.pointe = $('#pointe').is(":checked");
        currentEvent.event.extendedProps.data.paye = $('#paye').is(":checked");
        currentEvent.event.extendedProps.data.info = $('#commentEventBooked').val();
        currentEvent.event.extendedProps.data.motif = $("#motifBooked option:selected").text();
        currentEvent.event.extendedProps.data.idMotif = $("#motifBooked").val();
        currentEvent.event.setProp("color", idMotifMapCab[$("#motifBooked").val()].color);
        moveEvent([createJsonEvent(currentEvent.event)]);
        calendar.getEventById(currentEvent.event.id).remove();
    });

    //Do nothing on submit
    $("#eventFreeFormBooked").submit(function (e) {
        e.preventDefault();
    });


    //Supp Canceled RDV
    $("#suppEventCanceled").click(function () {
        $('#popupSingleEventCanceled').modal('hide');
        calendar.getEventById(currentEvent.event.id).remove();
        removeEvents([createJsonEvent(currentEvent.event)]);
    });

    //Do nothing on submit
    $("#eventFreeFormCanceled").submit(function (e) {
        e.preventDefault();
    });


    /* ------------------ Global functions ---------------------*/

    function createNewEvent(idEvent, title, start, end, color, status, idPatient, nomPatient, idMotif, motif, duration, info, pointe, paye, listIdMotif, idAdmin) {
        return {
            id: idEvent,
            title: title,
            start: start,
            end: end,
            color: color,
            editable: true,
            durationEditable: false,
            data: {
                status: status,
                idPatient: idPatient,
                nomPatient: nomPatient,
                idMotif: idMotif,
                motif: motif,
                duration: duration,
                info: info,
                pointe: pointe,
                id: idEvent,
                paye: paye,
                listIdMotif: listIdMotif,
                idAdmin: idAdmin
            }
        }
    }

    function createJsonEvent(event) {
        return {
            id: event.extendedProps.data.id,
            title: event.title,
            start: moment(event.start).format("YYYY-MM-DD HH:mm:ss"),
            end: moment(event.end).format("YYYY-MM-DD HH:mm:ss"),
            color: event.backgroundColor,
            editable: true,
            durationEditable: false,
            data: {
                status: event.extendedProps.data.status,
                idPatient: event.extendedProps.data.idPatient,
                nomPatient: event.extendedProps.data.nomPatient,
                idMotif: event.extendedProps.data.idMotif,
                motif: event.extendedProps.data.motif,
                duration: event.extendedProps.data.duration,
                info: event.extendedProps.data.info,
                pointe: event.extendedProps.data.pointe,
                id: event.extendedProps.data.id,
                paye: event.extendedProps.data.paye,
                listIdMotif: event.extendedProps.data.listIdMotif,
                idAdmin: event.extendedProps.data.idAdmin
            }
        }
    }

    function resetMonthPopup() {
        $("#daySelection").val("default").change();
        $('#finDaySelectionDiv').hide();
        $('#finDaySelection').empty();
        $("#debutDaySelection").empty();
        $("#debutDaySelectionDiv").hide();
        $('.daySelectect').hide();
        $('#MonthSelectionModal').modal('show');
    }

    //Maybe some lines UseLess
    function resetWeekDayPopup() {
        $("#timeGridSelect").val("default").change();
        $("#suppRDV").hide();
        $("#createListRDV").hide();
        $("#createPostIt").hide();
        $('.daySelectect2').hide();
        $('#timeGrid').modal('show');
    }

    function removeEvent(start, end) {
        var arrayEvents = [];
        calendar.getEvents().forEach(function (event) {
            if (start.diff(event.start) <= 0 && end.diff(event.start) >= 0) {
                arrayEvents.push(createJsonEvent(event));
                event.remove();
            }
        });
        removeEvents(arrayEvents);
    }

    function removeEvents(listEvents) {
        $.ajax({
            data: {listEvents: JSON.stringify(listEvents), tokenAdmin: readCookie('session')},
            type: 'POST',
            url: '/rdv/removerdv',
            success: function (data, textStatus, jqXHR) {
                var jsonData = JSON.parse(data);
                if (jsonData.status === "OK") {
                    //Nothing
                } else {
                    $('#modaleMessageTitle').text("Une erreur est survenue");
                    $('#dialog_title_span').text(jsonData.message);
                    $('#modalMessage').modal('toggle');
                    calendar.refetchEvents();
                }
            },
            error: function (jqXHR, textStatus, errorThrown) {
                $('#dialog_title_span').text("Un probleme est survenue veuillez contacter un administrateur");
                $('#modaleMessageTitle').text("Une erreur est survenue");
                $('#modalMessage').modal('toggle');
            }
        });
    }


    //Select Admin Calendar
    $("#adminName").change(function () {
        if ($(this).val() != currentIdAdmin) {
            window.location.href = ("/moncalendrier.html?id=" + $(this).val());
        }
    });

</script>
<script>
    moment.locale('fr', {
        months: 'Janvier_Février_Mars_Avril_Mai_Juin_Juillet_Août_Septembre_Octobre_Novembre_Décembre'.split('_'),
        monthsShort: 'janv._févr._mars_avr._mai_juin_juil._août_sept._oct._nov._déc.'.split('_'),
        monthsParseExact: true,
        weekdays: 'Dimanche_Lundi_Mardi_Mercredi_Jeudi_Vendredi_Samedi'.split('_'),
        weekdaysShort: 'dim._lun._mar._mer._jeu._ven._sam.'.split('_'),
        weekdaysMin: 'Di_Lu_Ma_Me_Je_Ve_Sa'.split('_'),
        weekdaysParseExact: true,
        longDateFormat: {
            LT: 'HH:mm',
            LTS: 'HH:mm:ss',
            L: 'DD/MM/YYYY',
            LL: 'D MMMM YYYY',
            LLL: 'D MMMM YYYY HH:mm',
            LLLL: 'dddd D MMMM YYYY HH:mm'
        },
        calendar: {
            sameDay: '[Aujourd’hui à] LT',
            nextDay: '[Demain à] LT',
            nextWeek: 'dddd [à] LT',
            lastDay: '[Hier à] LT',
            lastWeek: 'dddd [dernier à] LT',
            sameElse: 'L'
        },
        relativeTime: {
            future: 'dans %s',
            past: 'il y a %s',
            s: 'quelques secondes',
            m: 'une minute',
            mm: '%d minutes',
            h: 'une heure',
            hh: '%d heures',
            d: 'un jour',
            dd: '%d jours',
            M: 'un mois',
            MM: '%d mois',
            y: 'un an',
            yy: '%d ans'
        },
        dayOfMonthOrdinalParse: /\d{1,2}(er|e)/,
        ordinal: function (number) {
            return number + (number === 1 ? 'er' : 'e');
        },
        meridiemParse: /PD|MD/,
        isPM: function (input) {
            return input.charAt(0) === 'M';
        },
        meridiem: function (hours, minutes, isLower) {
            return hours < 12 ? 'PD' : 'MD';
        },
        week: {
            dow: 1, // Monday is the first day of the week.
            doy: 4  // Used to determine first week of the year.
        }
    });

    function pgdcListe(input) {
        if (toString.call(input) !== "[object Array]")
            return false;
        var len, a, b;
        len = input.length;
        if (!len) {
            return null;
        }
        a = input[0];
        for (var i = 1; i < len; i++) {
            b = input[i];
            a = pgdc(a, b);
        }
        return a;
    }

    function pgdc(x, y) {
        if ((typeof x !== 'number') || (typeof y !== 'number'))
            return false;
        x = Math.abs(x);
        y = Math.abs(y);
        while (y) {
            var t = y;
            y = x % y;
            x = t;
        }
        return x;
    }
</script>
</body>
</html>